<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Accumulate texture</title>
        <script type="text/javascript" src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/regl/2.1.0/regl.js" integrity="sha512-FgmtfNZApTrLMIs/sEBR+RjqVxVqJM7iloUqYLlp2YFFqn7zyDVJ8FllBZMBMHKc2mAXZQ+lLy2ZizpXmI5PdA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script> -->
    </head>

    <body>
        <button id="reset">reset</button>
        <camvas id="glcanvas"></camvas>
        <script type="module">
            import {vec2, glMatrix, mat4} from 'https://cdn.jsdelivr.net/npm/gl-matrix@3.4.3/+esm'

            function makeCircle (N=36)
            {
                return Array(N).fill().map((_, i) => {
                    var phi = 2 * Math.PI * (i / N)
                    return [Math.cos(phi), Math.sin(phi)]
                })
            }

            function makeQuad()
            {
                return [
                    [-1, -1],
                    [ 1, -1],
                    [ 1,  1],
                    [-1,  1]
                ]
            }

            function init(element)
            {
                const regl = createREGL({
                    container: element, 
                    extensions: ['OES_texture_float', "OES_texture_half_float"]
                });

                // utilities   
                const setupQuad = regl({
                    viewport: {x: 0, y: 0, w: 1, h: 1},
                    depth: { enable: false },
                    primitive: "triangle fan",
                    attributes: {
                    position: [
                        [ 0, 0],
                        [ 1, 0],
                        [ 1, 1],
                        [ 0, 1]
                    ],
                    uv:[
                        [ 0, 0],
                        [ 1, 0],
                        [ 1, 1],
                        [ 0, 1]
                        ]
                    },
                    count: 6,
                    uniforms: {
                        projection: mat4.ortho(mat4.identity([]), 0,1,0,1,-1,1),
                        texture: regl.prop("texture")
                    },
                    vert: `
                        precision mediump float;
                        uniform mat4 projection;
                        attribute vec2 position;
                        attribute vec2 uv;
                        varying vec2 vUV;
                        void main() {
                            vUV = uv;
                            gl_Position = projection * vec4(position, 0, 1);
                        }`,

                    frag: `
                        precision mediump float;
                        varying vec2 vUV;
                        uniform sampler2D texture;
                    
                        void main() {
                            vec4 tex = texture2D(texture, vUV).rgba;
                            gl_FragColor = vec4(tex.r, tex.g, tex.b, 1.0);
                        }`
                    });

                const setupScene = regl({
                    viewport: {x: 0, y: 0, w: 512, h: 512},
                    vert: `precision mediump float;
                        attribute vec2 position;
                        uniform mat4 projection;
                        uniform mat4 view;
                        uniform mat4 model;
                        void main () {
                            gl_Position = projection * view * model * vec4(position, 0, 1);
                        }`,

                    frag: `precision mediump float;
                        uniform vec4 color;
                        void main () {
                            gl_FragColor = color;
                        }`,
                    uniforms: {
                        view: mat4.identity([]),
                        projection: mat4.ortho(mat4.identity([]), 0,512,0,512,-1,1) //left, right, bottom, top, near, far
                    }
                });

                const drawToFbo = regl({
                    framebuffer: regl.prop("framebuffer")
                })

                // create fbos
                const sceneTexture = regl.texture({
                    width: 1,
                    height: 1,
                    wrap: 'clamp',
                    format: "rgba",
                    type: "float"
                });

                const sceneFbo = regl.framebuffer({
                    color: sceneTexture,
                    depth: false
                });

                const bufferTexture = regl.texture({
                    width: 1,
                    height: 1,
                    wrap: 'clamp',
                    format: "rgba",
                    type: "float"
                });
                const bufferFbo = regl.framebuffer({
                    color: bufferTexture,
                    depth: false
                });

                const compTexture = regl.texture({
                    width: 1,
                    height: 1,
                    wrap: 'clamp',
                    format: "rgba",
                    type: "float"
                });
                const compFbo = regl.framebuffer({
                    color: compTexture,
                    depth: false
                });

                const toneTexture = regl.texture({
                    width: 1,
                    height: 1,
                    wrap: 'clamp',
                    format: "rgba",
                    type: "float"
                });

                const toneFbo = regl.framebuffer({
                    color: toneTexture,
                    depth: false
                });

                // start animation loop
                let k=0
                regl.frame(({tick, viewportWidth, viewportHeight}) => {
                    sceneFbo.resize(64,64);
                    bufferFbo.resize(64,64);
                    compFbo.resize(64,64);
                    toneFbo.resize(64,64);

                    /* ==================== *
                    * Main render commands *
                    * ==================== */
                    // draw scene to scene_texture
                    drawToFbo({framebuffer: sceneFbo}, ()=>{
                        regl.clear({color: [0,0,0,1]});
                        setupScene({}, ()=>{
                            // draw 1st circle
                            let model = mat4.fromTranslation(mat4.identity([]), [Math.sin(tick*0.1)*128+256, 256, 0])
                            mat4.scale(model, model, [50,50,50])
                            regl({
                                framebuffer: sceneFbo,
                                uniforms: {
                                    color: [1, 1, .9, 1.0],
                                    model: model,
                                },
                                attributes: {
                                    position: makeCircle(36)
                                },
                                primitive: 'triangle fan',
                                count: 36
                            })();

                            // draw 2nd circle
                            let model2 = mat4.fromTranslation(mat4.identity([]), [Math.sin(tick*0.1)*128+256, Math.cos(tick*0.1)*128+256, 0])
                            mat4.scale(model2, model2, [50,50,50])
                            regl({
                                framebuffer: sceneFbo,
                                uniforms: {
                                    color: [1, 1, .9, 1.0],
                                    model: model2,
                                },
                                attributes: {
                                    position: makeCircle(36)
                                },
                                primitive: 'triangle fan',
                                count: 36
                            })();
                        });
                    });

                    // render scene+buffer to comp
                    setupQuad({}, ()=>{
                        regl({
                            framebuffer: compFbo,
                            uniforms: {
                                textureA: sceneTexture,
                                textureB: bufferTexture
                            },
                            frag: `precision mediump float;
                            varying vec2 vUV;
                            uniform sampler2D textureA;
                            uniform sampler2D textureB;
                        
                            void main() {
                                vec4 texA = texture2D(textureA, vUV).rgba;
                                vec4 texB = texture2D(textureB, vUV).rgba;
                                gl_FragColor = vec4(texA.rgb+texB.rgb, 1.0);
                            }`
                        })();
                    });
                    
                
                    // copy comp to buffer
                    setupQuad({}, ()=>{
                        regl({
                            framebuffer: bufferFbo,
                            uniforms: {
                                texture: compTexture
                            },
                            frag: `precision mediump float;
                            varying vec2 vUV;
                            uniform sampler2D texture;

                            void main() {
                                vec4 tex = texture2D(texture, vUV).rgba;
                                gl_FragColor = vec4(tex.rgb, 1.0);
                            }`
                        })()
                    });


                    // tone down added light intensities
                    k++;
                    setupQuad({}, ()=>{
                        regl({
                            framebuffer: toneFbo,
                            uniforms: {
                                texture: compTexture,
                                exposure: 1/k
                            },

                            frag: `
                            precision mediump float;
                            varying vec2 vUV;
                            uniform sampler2D texture;
                            uniform float exposure;
                        
                            void main() {
                                vec4 tex = texture2D(texture, vUV).rgba;
                                gl_FragColor = vec4(tex.rgb*exposure, 1.0);
                            }`
                        })();
                    });


                    // render texture to screen
                    setupQuad({}, ()=>{
                        regl({
                            uniforms:{
                                texture: toneTexture
                            }
                        })();
                    });
                });
            }

            const glcanvas = document.getElementById("glcanvas")
            start(glcanvas);

            // reset_btn.addEventListener("click", ()=>{
            //     drawToFbo({framebuffer: bufferFbo}, ()=>{
            //         regl.clear({color: [0,0,0,1]});
            //     });
            //     k=0;
            // });
        </script>
    </body>
</html>